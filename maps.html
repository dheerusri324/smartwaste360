<!-- maps.html -->
<div class="map-container">
    <div id="map" style="height: 400px; width: 100%;"></div>
    
    <div class="map-controls">
        <button id="find-colonies">Find Nearby Colonies</button>
        <button id="show-collections">Show Collection Points</button>
    </div>
    
    <div id="colony-list" class="colony-list"></div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD85oylQHdTNG5XqMOWUARW8ksDRBhSp3k&libraries=places"></script>
<script>
let map;
let userMarker;
let colonies = [];

function initMap() {
    // Get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Create map centered on user
                map = new google.maps.Map(document.getElementById('map'), {
                    center: userLocation,
                    zoom: 14
                });
                
                // Add user marker
                userMarker = new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: 'Your Location',
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    }
                });
                
                // Load nearby colonies
                loadNearbyColonies(userLocation);
            },
            error => {
                // Default to a central location if geolocation fails
                const defaultLocation = { lat: 28.6139, lng: 77.2090 }; // Delhi
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultLocation,
                    zoom: 10
                });
                console.error('Error getting location:', error);
            }
        );
    }
}

async function loadNearbyColonies(location) {
    try {
        const response = await fetch(`/api/colonies/nearby?lat=${location.lat}&lng=${location.lng}&radius=10`);
        colonies = await response.json();
        
        // Add colony markers
        colonies.forEach(colony => {
            const marker = new google.maps.Marker({
                position: { lat: parseFloat(colony.latitude), lng: parseFloat(colony.longitude) },
                map: map,
                title: colony.colony_name,
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                }
            });
            
            // Add info window
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div class="colony-info">
                        <h3>${colony.colony_name}</h3>
                        <p>Points: ${colony.total_points}</p>
                        <p>Users: ${colony.total_users}</p>
                        <button onclick="selectColony(${colony.colony_id})">Select This Colony</button>
                    </div>
                `
            });
            
            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });
        });
        
        // Update colony list
        updateColonyList();
    } catch (error) {
        console.error('Error loading colonies:', error);
    }
}

function updateColonyList() {
    const listContainer = document.getElementById('colony-list');
    listContainer.innerHTML = '';
    
    colonies.forEach(colony => {
        const colonyElement = document.createElement('div');
        colonyElement.className = 'colony-item';
        colonyElement.innerHTML = `
            <h4>${colony.colony_name}</h4>
            <p>Distance: ${calculateDistance(
                userMarker.getPosition().lat(),
                userMarker.getPosition().lng(),
                parseFloat(colony.latitude),
                parseFloat(colony.longitude)
            ).toFixed(2)} km</p>
            <p>Points: ${colony.total_points}</p>
            <button onclick="selectColony(${colony.colony_id})">Join Colony</button>
        `;
        listContainer.appendChild(colonyElement);
    });
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

async function selectColony(colonyId) {
    try {
        const response = await fetch('/api/user/colony', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ colony_id: colonyId })
        });
        
        if (response.ok) {
            alert('Successfully joined colony!');
            // Refresh colony data
            loadNearbyColonies(userMarker.getPosition());
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error selecting colony:', error);
    }
}

// Initialize map when page loads
initMap();
</script>